# ESP32-S3 心率监测与中继 (Heart Rate Monitor & Relay)

本项目基于 ESP32-S3 实现了一个心率监测器，具有以下功能：
1. **连接手环**：作为中心设备（Central），自动连接 BLE 心率手环（如小米、华为等）。
2. **显示心率**：在 **LCD9648 (ST7565)** 屏幕上显示心率数据。
3. **心率广播**：作为 BLE 服务端（Peripheral），将获取的心率数据转发广播给其他设备。
4. **声光反馈**：根据心率更新控制 LED 闪烁和蜂鸣器鸣叫。
5. **显示切换**：支持通过按键切换“数字显示”和“心电波形”模式。

## 硬件接线 (Hardware Wiring)

### LCD 屏幕 (LCD9648 / ST7565)
- **SDA (MOSI)**: GPIO 7
- **SCL (CLK)**:  GPIO 6
- **CS**:         GPIO 5
- **RS (DC)**:    GPIO 18
- **RST**:        GPIO 17
- **VCC**:        3.3V
- **GND**:        GND

### 外设 (Peripherals)
- **LED 指示灯**: GPIO 2 (高电平点亮)
- **蜂鸣器**:    GPIO 4 (高电平鸣叫)
- **按键**:      GPIO 14 (用户按键, 低电平触发, **不要使用 GPIO 0/BOOT 键**)

## 接线图

```
      ESP32-S3               外接元件
    +-----------+
    |           |
    |    3.3V   |--------+---> LCD VCC
    |     GND   |---+----+---> LCD GND
    |           |   |    +---> 按键 (另一端接 GND)
    |           |   |    +---> LED 负极 (-) (或通过电阻接正极)
    |           |   |    +---> 蜂鸣器负极 (-)
    |           |   |
    |   GPIO 7  |--------> LCD SDA
    |   GPIO 6  |--------> LCD SCL
    |   GPIO 5  |--------> LCD CS
    |   GPIO 18 |--------> LCD RS
    |   GPIO 17 |--------> LCD RST
    |           |
    |   GPIO 2  |--------[ 1K 电阻 ]----> LED 正极 (+) ----> (负极接 GND)
    |           |          (限流保护)
    |           |
    |   GPIO 4  |--------> 蜂鸣器正极 (+)
    |           |
    |   GPIO 14 |--------> 按键 (一端) ----> (另一端接 GND)
    +-----------+
```

**注意**：
- **按键**：请使用 GPIO 14，不要使用 GPIO 0 (BOOT) 或 GPIO 13 (JTAG)，以免引起复位或冲突。
- **蜂鸣器**：如果使用的是无源蜂鸣器，可能需要三极管驱动；对于简单的有源蜂鸣器或小功率压电蜂鸣器，直接驱动（或串联小电阻）通常可以工作。

## 功能特性 (Features)

- **自动连接**：自动扫描并连接提供心率服务 (UUID 0x180D) 的设备。
- **显示模式**：
  - **数字模式**：大字体显示当前心率数值。无数据时显示 "WAIT"。
  - **波形模式**：显示模拟的心电图 (ECG) 动态波形。
    - **平滑滚动**：波形从右向左平滑滚动。
    - **QRS 模拟**：生成带有 QRS 波群的模拟心跳曲线。
    - **动态频率**：波形跳动速度随实际心率自动调整。
    - **清晰显示**：波形线条加粗 (2px)，并在快速跳变处自动插值，保证曲线连续不断裂。
- **反馈机制**：
  - **LED**：每次心率更新时闪烁。
  - **蜂鸣器**：每次心率更新时鸣叫，鸣叫时长随心率动态调整（心率越高，鸣叫越短促）。

## 使用说明 (Usage)

1. **编译与烧录**：将项目编译并烧录到 ESP32-S3 开发板。
2. **手环准备**：确保你的心率手环处于广播状态（未连接手机）。
3. **自动连接**：ESP32-S3 启动后会自动搜索并连接手环。
4. **查看数据**：连接成功后，屏幕上将显示心率数值。
5. **切换视图**：按下用户按键 (**GPIO 14**) 可在“数字视图”和“波形视图”之间切换。
6. **数据转发**：你可以使用手机上的 BLE 调试助手连接名为 "ESP32_HRM_RELAY" 的设备，查看转发的心率数据。
